# Backend: Google Apps Script (GAS)

## 1. Архитектура Backend
Скрипт выполняет роль прослойки между Flutter-приложением и Google Таблицами. 

### Ключевые особенности реализации:
*   **Динамический маппинг заголовков**: Скрипт не привязан к жестким номерам столбцов (например, `A`, `B`, `C`). Он сканирует первую строку каждого листа и находит нужные данные по названию колонки. Это делает систему устойчивой к добавлению новых столбцов вручную.
*   **Конкурентность (LockService)**: При записи отчетов используется механизм блокировок. Если два пользователя нажмут «Отправить» одновременно, скрипт выстроит их в очередь, предотвращая повреждение данных.
*   **Регистронезависимость**: Поиск колонок (например, `ID` vs `id`) и статусов выполняется без учета регистра и лишних пробелов.

## 2. Основные функции

### `getHeaders(sheetName)`
Центральная функция для работы с таблицей. Возвращает объект с картой индексов всех колонок. Понимает синонимы (например, `наименование` и `name`).

### `checkUserAccess(userId)`
Проверяет статус пользователя и возвращает его роль, имя и фирму-подрядчика.

### `doGet(e)`
Обрабатывает все входящие запросы на чтение данных:
*   Список доступных объектов.
*   Список позиций (с фильтром по `object_id`).
*   Агрегированная статистика для раздела «Выработка».
*   Список пользователей для админ-панели.

### `doPost(e)`
Обрабатывает команды на запись:
*   `sendReport`: Сохранение данных в журнал `Data_v2` с расчетом маржинальности.
*   `addUser/updateUser/deleteUser`: CRUD-операции уровня администратора.
*   `sendExcel`: Пересылка сформированного на клиенте файла в Telegram-группу.

## 3. Обработка ошибок
Скрипт всегда возвращает JSON-ответ со статусом:
*   `status: "authorized"` / `status: "unauthorized"`
*   `status: "ok"`
*   `status: "error", message: "..."`
