# План модернизации: Мульти-объекты и Матрица цен (Contractor-based)

Этот документ описывает реализацию системы управления объектами и гибкой экономики на основе привязки пользователей к подрядчикам и динамического поиска цен.

## 1. Структура Базы Данных (Google Sheets)

### Лист `Users` (Управление персоналом)
Добавить колонку:
- `Contractor`: Название фирмы-подрядчика (например, `ИП Володина`).

### Лист `Positions` (Матрица цен)
Структура колонок:
- `id`, `name`, `unit`... (базовые данные).
- `client_price`: Цена для заказчика.
- `[Название Подрядчика 1]`: Колонка с ценами для первой фирмы.
- `[Название Подрядчика 2]`: Колонка с ценами для второй фирмы.
*(Количество колонок может расти по мере появления новых подрядчиков).*

### Лист `Objects` и `UserAssignments`
- Оставляем как планировали ранее (для управления доступом к объектам).

### Лист `Data_v2` (Журнал экономики)
- `date`: Дата.
- `user_id`: Кто.
- `object_id`: Объект.
- `position_id`: Работа.
- `qty`: Кол-во.
- `rate`: Ставка (подтянутая из колонки подрядчика).
- `client_price`: Цена для заказчика (подтянутая из `client_price`).
- `margin`: Прибыль (`client_price - rate` * `qty`).

---

## 2. Логика Backend (GAS)

### Динамический поиск цены (`getPriceForUser`):
1. Скрипт получает `userId`.
2. Находит в `Users` соответствующий `Contractor`.
3. В листе `Positions` находит колонку, заголовок которой совпадает с `Contractor`.
4. Из этой колонки берет цену для конкретной `positionId`.

### Запись отчета:
- Скрипт создает новую строку в `Data_v2` для каждой позиции из отчета.
- Цены фиксируются в момент записи (Snapshot), чтобы изменение цен в будущем не меняло старые отчеты.

---

## 3. Статус реализации

### Фаза 1: Настройка таблиц - ✅ ЗАВЕРШЕНО
- [x] Добавить колонку `Contractor` в `Users`.
- [x] Создать колонки подрядчиков в `Positions`.
- [x] Заполнить тестовые данные (ID, Имена, Цены).

### Фаза 2: Обновление GAS - ✅ ЗАВЕРШЕНО
- [x] Реализовать функцию `doGet` с возвратом списка объектов.
- [x] Реализовать функцию `doPost` с логикой "Матрицы цен".

### Фаза 3: Обновление Flutter - ✅ ЗАВЕРШЕНО
- [x] Добавить экран выбора объекта.
- [x] Обновить модели данных.
